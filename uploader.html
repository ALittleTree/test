<html>

<head>
  <title>TUS Uploader</title>
  <style>
    .parent {
      display: grid;
      grid-template-columns: 1fr 2fr;
      grid-template-rows: repeat(10, 1fr);
      grid-column-gap: 0px;
      grid-row-gap: 5px;
    }
  </style>
  <script>
    function parseInput() {
      const input = {
        basePath: document.getElementById('env').value,
        sessionInfo: {
          vin: document.getElementById('vin').value,
          lapIndex: parseInt(document.getElementById('lapIndex').value, 10),
          trackId: document.getElementById('trackId').value,
          name: document.getElementById('name').value,
          videoLeading: parseInt(document.getElementById('videoLeading').value, 10),
          videoTrail: parseInt(document.getElementById('videoTrail').value, 10),
        },
        files: {
          hdf5: document.getElementById('hdf5').files.item(0),
          mp4: document.getElementById('mp4').files.item(0),
        }
      }
      if (!input.sessionInfo.vin || !input.files.hdf5) {
        throw new Error("Missing input data");
      }
      return input;
    }

    function getAuthToken(basePath) {
      return fetch(`${basePath}/token`, {
        method: 'POST',
        body: JSON.stringify({
          appId: "e9e7648a-665b-4707-bb63-81ce27a2069f",
          secret: "cae9cfe573c399c28153704c5832f33eab5d3dcd71f62556c0523a5f67d54f40",
        }),
      })
        .then(response => response.json())
        .then(response => response.token);
    }

    function createSession(basePath, token, sessionInfo) {
      return fetch(`${basePath}/session`, {
        method: 'POST',
        body: JSON.stringify(sessionInfo),
        headers: {
          'Authorization': `Bearer ${token}`,
        },
      })
        .then(response => response.json())
        .then(response => response.sessionId);
    }

    function getMimeType(file) {
      return file.type || 'application/tlm';
    }

    function newUpload(basePath, token, sessionId, file) {
      return new Promise((resolve, reject) => {
        mimeType = getMimeType(file);
        const upload = new tus.Upload(file, {
          endpoint: `${basePath}/data/files`,
          headers: {
            Authorization: `Bearer ${token}`,
          },
          metadata: {
            filename: file.name,
            filetype: mimeType,
            sessionId, 
            token,
            contentType: mimeType,
          },
          // Callback for errors which cannot be fixed using retries
          onError: function (error) {
            log(`âŒ [${file.name}] Upload failed: ${error}`)
            reject(error);
          },
          // Callback for reporting upload progress
          onProgress: function (bytesUploaded, bytesTotal) {
            const percentage = (bytesUploaded / bytesTotal * 100).toFixed(2);
            log(`ðŸš§ [${file.name}] Uploading... ${percentage}% (${bytesUploaded}/${bytesTotal}`);
          },
          // Callback for once the upload is completed
          onSuccess: function () {
            log(`ðŸ [${file.name}] Uploaded!`);
            resolve();
          }
        });
        upload.start();
      })
    }

    async function upload() {
      try {
        clearLog();

        log('ðŸ“– Parsing config...');
        const data = parseInput();
        log('ðŸ“– Parsing complete.');

        log(`ðŸŽï¸ Uploading as VIN: "${data.sessionInfo.vin}" to ENV: "${data.basePath}"`);

        log("ðŸ”‘ Creating auth token...");
        const token = await getAuthToken(data.basePath);
        log("ðŸ”‘ Token created.");

        log("âœ¨ Creating session...");
        const sessionId = await createSession(data.basePath, token, data.sessionInfo);
        log(`âœ¨ Session created: ${sessionId}`);

        log("ðŸŽ¬ Uploading file(s)...");
        await newUpload(data.basePath, token, sessionId, data.files.hdf5);
        if (data.files.mp4 != null) {
          await newUpload(data.basePath, token, sessionId, data.files.hdf5);
        }
        log("âœ… DONE!");
      } catch (error) {
        log("âŒ An error occurred: " + error)
      } finally {
        return false;
      }
    }
    function init() {
      logArea = document.getElementById('log')
    }
    function log(text) {
      logArea.innerHTML += text + '\n';
      setTimeout(() => {
        logArea.scrollTop = logArea.scrollHeight;
      }, 0)
    }
    function clearLog() {
      logArea.innerHTML = '';
    }
    window.onload = init;
  </script>
</head>

<body>
  <h1>Manual upload tester for TUSD</h1>
  <p>Please note that the interpreter won't probably accept the HDF5, so this is to be used to test only the first part of the workflow (upload through TUSD and checks by TLM-API).</p>
  <div class="parent">
    <label for="vin">VIN</label>
    <input type="text" id="vin" />
    <label for="env">ENVIRONMENT</label>
    <select id="env">
      <option value="http://localhost:1080/v1.0">Localhost</option>
      <option value="https://pre-sdp.lamborghini.com/v1.0">PRE</option>
      <option value="https://qua-sdp.lamborghini.com/v1.0">QUA</option>
      <option value="https://prod-sdp.lamborghini.com/v1.0">PROD</option>
    </select>
    <label for="lapIndex">Lap</label>
    <input type="number" id="lapIndex" value="1" />
    <label for="trackId">Track</label>
    <input type="text" id="trackId" value="TestTrack" />
    <label for="name">Driver</label>
    <input type="text" id="name" value="TestDriver" />
    <label for="videoLeading">Video Leading</label>
    <input type="number" id="videoLeading" value="0" />
    <label for="videoTrail">Video Trailing</label>
    <input type="number" id="videoTrail" value="0" />
    <label for="hdf5">HDF5</label>
    <input type="file" id="hdf5" accept=".tlm" />
    <label for="mp4">MP4</label>
    <input type="file" id="mp4" accept=".mp4" />
    <input type="button" value="UPLOAD" onclick="upload()">
  </div>
  <p>Log:</p>
  <textarea id="log" disabled rows="30" cols="150"></textarea>
  <script src="https://cdn.jsdelivr.net/npm/tus-js-client@latest/dist/tus.min.js"></script>
</body>

</html>